# 事件循环 event loop

## 任务介绍

将任务分为两类：

- 同步任务
- 异步任务

当我们打开网站时，网页的渲染过程就是一大堆同步任务，比如页面骨架和页面元素的渲染。而像加载图片音乐之类占用资源大耗时久的任务，就是异步任务。关于这部分有严格的文字定义，但本文的目的是用最小的学习成本彻底弄懂执行机制，所以我们用导图来说明：

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2017/11/21/15fdd88994142347~tplv-t2oaga2asx-no-mark:1280:960:0:0.awebp)

导图要表达的内容用文字来表述的话：

- 同步和异步任务分别进入不同的执行"场所"，同步的进入主线程，异步的进入Event Table并注册函数。
- 当指定的事情完成时，Event Table会将这个函数移入Event Queue。
- 主线程内的任务执行完毕为空，会去Event Queue读取对应的函数，进入主线程执行。
- 上述过程会不断重复，也就是常说的Event Loop(事件循环)。

除了广义的同步任务和异步任务，我们对任务有更精细的定义：

- macro-task(宏任务)：包括整体代码script，setTimeout，setInterval
- micro-task(微任务)：Promise，process.nextTick

不同类型的任务会进入对应的Event Queue，比如`setTimeout`和`setInterval`会进入相同的Event Queue。

事件循环的顺序，决定js代码的执行顺序。进入整体代码(宏任务)后，开始第一次循环。接着执行所有的微任务。然后再次从宏任务开始，找到其中一个任务队列执行完毕，再执行所有的微任务。

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2017/11/21/15fdcea13361a1ec~tplv-t2oaga2asx-no-mark:1280:960:0:0.awebp)

## 写在最后

### (1)js的异步

我们从最开头就说javascript是一门单线程语言，不管是什么新框架新语法糖实现的所谓异步，其实都是用同步的方法去模拟的，牢牢把握住单线程这点非常重要。

### (2)事件循环Event Loop

事件循环是js实现异步的一种方法，也是js的执行机制。

### (3)javascript的执行和运行

执行和运行有很大的区别，javascript在不同的环境下，比如node，浏览器，Ringo等等，执行方式是不同的。而运行大多指javascript解析引擎，是统一的。

### (4)setImmediate

微任务和宏任务还有很多种类，比如`setImmediate`等等，执行都是有共同点的，有兴趣的同学可以自行了解。

### (5)最后的最后

- javascript是一门单线程语言
- Event Loop是javascript的执行机制

## 浏览器线程

虽然说`JavaScript`是单线程语言，但是浏览器不是单线程的。而不同的线程就会对不同的事件进行处理，当对应事件可以执行的时候，对应线程就会将其放入任务队列。

- **js引擎线程**：用于解释执行js代码、用户输入、网络请求等；
- **GUI渲染线程**：绘制用户界面，与JS主线程互斥（因为js可以操作DOM，进而会影响到GUI的渲染结果）；
- **http异步网络请求线程**：处理用户的get、post等请求，等返回结果后将回调函数推入到任务队列；
- **定时触发器线程**：`setInterval`、`setTimeout`等待时间结束后，会把执行函数推入任务队列中；
- **浏览器事件处理线程**：将`click`、`mouse`等UI交互事件发生后，将要执行的回调函数放入到事件队列中。

## 宏任务和微任务

![image-20210827180453766](%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.assets/image-20210827180453766.png)

- 当我们第一次执行的时候，解释器会将整体代码`script`放入宏任务队列中，因此事件循环是从第一个宏任务开始的；
- 如果在执行微任务的过程中，产生新的微任务添加到微任务队列中，也需要一起清空；微任务队列没清空之前，是不会执行下一个宏任务的。

## 页面渲染

最后来讲将事件循环中的页面更新渲染，这也是`Vue`中异步更新的逻辑所在。

**每次当一次事件循环结束后，即一个宏任务执行完成后以及微任务队列被清空后，浏览器就会进行一次页面更新渲染。**

通常我们浏览器页面刷新频率是60fps，也就是意味着16.67ms要刷新一次，因此我们也要尽量保证一次事件循环控制在16.67ms之内，这也是我们需要做代码性能优化的一个原因。

作者：ssssyoki
链接：[https://juejin.cn/post/6844903512845860872](https://juejin.cn/post/6844903512845860872)

>[十几张生动形象的GIF图带你彻底掌握 EventLoop](https://mp.weixin.qq.com/s/a_vfNw0rI2bZHG9xY_7z1Q)
